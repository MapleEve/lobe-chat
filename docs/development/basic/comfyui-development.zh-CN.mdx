---
title: ComfyUI æ‰©å±•å¼€å‘æŒ‡å—
description: å­¦ä¹ å¦‚ä½•ä¸º LobeChat ComfyUI é›†æˆæ·»åŠ æ–°æ¨¡å‹ã€å·¥ä½œæµå’ŒåŠŸèƒ½æ‰©å±•
tags:
  - ComfyUI
  - å¼€å‘æŒ‡å—
  - æ¨¡å‹æ‰©å±•
  - å·¥ä½œæµå¼€å‘
---

# ComfyUI æ‰©å±•å¼€å‘æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©å¼€å‘è€…æ‰©å±• LobeChat çš„ ComfyUI é›†æˆï¼ŒåŒ…æ‹¬æ·»åŠ æ–°æ¨¡å‹ã€åˆ›å»ºå·¥ä½œæµã€å¼€å‘ LoRA å’Œ ControlNet æ”¯æŒã€‚

## æ–°æ¶æ„æ¦‚è§ˆ

LobeChat ComfyUI é›†æˆé‡‡ç”¨åˆ†å±‚é…ç½®é©±åŠ¨çš„æ¨¡å—åŒ–æ¶æ„ï¼Œå…·å¤‡åˆ†å±‚é”™è¯¯å¤„ç†ã€åŠ¨æ€æ£€æµ‹å’Œ O (1) æ€§èƒ½ä¼˜åŒ–ï¼š

```
packages/model-runtime/src/comfyui/
â”œâ”€â”€ config/                    # å››å¤§é…ç½®æ³¨å†Œè¡¨ç³»ç»Ÿ
â”‚   â”œâ”€â”€ modelRegistry.ts       # 127ä¸ªFLUX/SD3æ¨¡å‹é…ç½®ï¼ˆ158ä¸ªå˜ä½“ï¼‰
â”‚   â”œâ”€â”€ systemComponents.ts    # 6ä¸ªç³»ç»Ÿç»„ä»¶ï¼ˆVAE/CLIP/T5ï¼‰
â”‚   â”œâ”€â”€ loraRegistry.ts        # 23ä¸ªLoRAé€‚é…å™¨ï¼ˆå®˜æ–¹+ä¸“ä¸š+ç¤¾åŒºï¼‰
â”‚   â””â”€â”€ controlnetRegistry.ts  # 3ä¸ªXLabs-AI ControlNetæ¨¡å‹
â”œâ”€â”€ workflows/                 # æ™ºèƒ½å·¥ä½œæµç³»ç»Ÿ
â”‚   â”œâ”€â”€ flux-dev.ts           # FLUX Devå·¥ä½œæµ
â”‚   â”œâ”€â”€ flux-schnell.ts       # FLUX Schnellå·¥ä½œæµ
â”‚   â”œâ”€â”€ flux-kontext.ts       # FLUX Kontextå·¥ä½œæµ
â”‚   â”œâ”€â”€ flux-krea.ts          # FLUX Kreaå·¥ä½œæµ
â”‚   â”œâ”€â”€ sd35.ts               # SD3.5åŠ¨æ€ç¼–ç å™¨å·¥ä½œæµ
â”‚   â””â”€â”€ sd35-incl-clip.ts       # SD3.5å†…ç½®ç¼–ç å™¨å·¥ä½œæµ
â”œâ”€â”€ utils/                     # é«˜æ€§èƒ½å·¥å…·å±‚
â”‚   â”œâ”€â”€ modelResolver.ts       # O(1)æ¨¡å‹è§£æå™¨ + æ™ºèƒ½ç¼“å­˜
â”‚   â”œâ”€â”€ workflowRouter.ts      # åŒå±‚è·¯ç”±ç³»ç»Ÿï¼ˆç²¾ç¡®+å˜ä½“ï¼‰
â”‚   â”œâ”€â”€ workflowDetector.ts    # æ¨¡å‹æ¶æ„æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ promptSplitter.ts      # æç¤ºè¯æ™ºèƒ½åˆ†å‰²
â”‚   â””â”€â”€ weightDType.ts         # æƒé‡æ•°æ®ç±»å‹ä¼˜åŒ–
â””â”€â”€ errors/                    # åˆ†å±‚é”™è¯¯å¤„ç†ç³»ç»Ÿ
    â””â”€â”€ index.ts               # å››ç±»å†…éƒ¨é”™è¯¯ï¼ˆConfig/Workflow/Utils/ModelResolverï¼‰
```

### æ–°æ¶æ„æ ¸å¿ƒç‰¹æ€§

#### ğŸš€ æ€§èƒ½ä¼˜åŒ–

- **O (1) æ¨¡å‹æŸ¥æ‰¾**: å“ˆå¸Œè¡¨æ›¿ä»£çº¿æ€§æœç´¢ï¼ŒæŸ¥æ‰¾é€Ÿåº¦æå‡ 10x+
- **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**: 1 åˆ†é’Ÿ TTL ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
- **ä¼˜å…ˆçº§è‡ªåŠ¨æ’åº**: åŸºäºæ¨¡å‹æ³¨å†Œè¡¨çš„æ™ºèƒ½é€‰æ‹©

#### ğŸ›¡ï¸ é”™è¯¯å¤„ç†å‡çº§

- **åˆ†å±‚é”™è¯¯æ¶æ„**: 4 ç±»ä¸“ç”¨é”™è¯¯ç±»å‹ï¼Œç²¾ç¡®å®šä½é—®é¢˜
- **HTTP çŠ¶æ€æ˜ å°„**: è‡ªåŠ¨åˆ†ç±» 401/403/5xx é”™è¯¯
- **è¯¦ç»†é”™è¯¯ä¸Šä¸‹æ–‡**: åŒ…å«å®Œæ•´è°ƒè¯•ä¿¡æ¯

#### ğŸ§  æ™ºèƒ½æ£€æµ‹ç³»ç»Ÿ

- **SD3.5 åŠ¨æ€ç¼–ç å™¨**: è‡ªåŠ¨æ£€æµ‹ 3 ç§ç¼–ç å™¨é…ç½®ï¼ˆTriple/Dual/T5ï¼‰
- **æ¨¡å‹æ¶æ„è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ« FLUX/SD3 æ¨¡å‹å®¶æ—
- **å…¼å®¹æ€§éªŒè¯**: LoRA/ControlNet å…¼å®¹æ€§è‡ªåŠ¨æ£€æŸ¥

#### ğŸ“Š é…ç½®é©±åŠ¨è®¾è®¡

- **158 ä¸ªæ¨¡å‹å˜ä½“**: å®Œæ•´çš„ FLUX/SD3.5 ç”Ÿæ€æ”¯æŒ
- **ä¸‰çº§ä¼˜å…ˆçº§ç³»ç»Ÿ**: å®˜æ–¹ (1) > ä¼ä¸š (2) > ç¤¾åŒº (3)
- **åŠ¨æ€å›é€€æœºåˆ¶**: æ™ºèƒ½é€‰æ‹©æœ€ä½³å¯ç”¨æ¨¡å‹

## æ·»åŠ æ–°æ¨¡å‹

### 1. æ›´æ–°æ¨¡å‹æ³¨å†Œè¡¨

åœ¨ `config/modelRegistry.ts` ä¸­æ·»åŠ æ–°æ¨¡å‹ï¼š

```typescript
export const MODEL_REGISTRY: Record<string, ModelConfig> = {
  // ç°æœ‰æ¨¡å‹...

  // æ·»åŠ æ–°æ¨¡å‹
  'your-new-model.safetensors': {
    priority: 2, // 1=å®˜æ–¹, 2=ä¼ä¸š, 3=ç¤¾åŒº
    variant: 'dev', // 'dev' | 'schnell' | 'kontext' | 'krea' | 'sd35'
    modelFamily: 'FLUX', // 'FLUX' | 'SD3'
    recommendedDtype: 'default', // 'default' | 'fp8_e4m3fn' | 'fp8_e5m2'
  },

  // é‡åŒ–ç‰ˆæœ¬
  'your-new-model-fp8.safetensors': {
    priority: 2,
    variant: 'dev',
    modelFamily: 'FLUX',
    recommendedDtype: 'fp8_e4m3fn',
  },
};
```

### 2. æ¨¡å‹é…ç½®æ¥å£

```typescript
export interface ModelConfig {
  modelFamily: 'FLUX' | 'SD1' | 'SDXL' | 'SD3';
  priority: number; // ä¼˜å…ˆçº§ï¼š1-3
  recommendedDtype: 'default' | 'fp8_e4m3fn' | 'fp8_e5m2' | 'fp8_e4m3fn_fast';
  variant: 'dev' | 'schnell' | 'kontext' | 'krea' | 'fill' | 'redux' | 'sd35';
}
```

### 3. æµ‹è¯•æ–°æ¨¡å‹

```typescript
// config/modelRegistry.test.ts
import { getModelConfig, getAllModelNames } from '../modelRegistry';

describe('New Model Registration', () => {
  test('should find new model in registry', () => {
    const config = getModelConfig('your-new-model.safetensors');
    expect(config).toBeDefined();
    expect(config?.variant).toBe('dev');
    expect(config?.modelFamily).toBe('FLUX');
  });

  test('should support priority-based queries', () => {
    const priority1Models = getAllModelNames().filter(name => {
      const config = getModelConfig(name);
      return config?.priority === 1;
    });
    expect(priority1Models.length).toBeGreaterThan(0);
  });
});
```

## åˆ›å»ºæ–°å·¥ä½œæµ

<Callout type={'warning'}>
  **é‡è¦ï¼å·¥ä½œæµèŠ‚ç‚¹æ¥æºè¯´æ˜**

  å·¥ä½œæµä¸­çš„èŠ‚ç‚¹ç»“æ„ä¸æ˜¯å‡­ç©ºåˆ›å»ºçš„ï¼Œè€Œæ˜¯æ¥è‡ª ComfyUI çš„åŸç”Ÿ API æ ¼å¼ï¼š

  1. åœ¨ ComfyUI ç•Œé¢ä¸­è®¾è®¡å·¥ä½œæµ
  2. ä½¿ç”¨ "Export (API Format)" å¯¼å‡º JSON
  3. å°† JSON ç»“æ„å¤åˆ¶åˆ° TypeScript æ–‡ä»¶ä¸­
  4. ç”¨ PromptBuilder åŒ…è£…æ­¤ JSON ç»“æ„
</Callout>

### 1. è·å–å·¥ä½œæµèŠ‚ç‚¹ç»“æ„

#### æ­¥éª¤ 1ï¼šåœ¨ ComfyUI UI ä¸­åˆ›å»ºå·¥ä½œæµ

1. æ‰“å¼€ ComfyUI ç•Œé¢
2. æ‹–æ‹½èŠ‚ç‚¹æ­å»ºæ‰€éœ€çš„å·¥ä½œæµ
3. è¿æ¥å„ä¸ªèŠ‚ç‚¹çš„è¾“å…¥è¾“å‡º
4. æµ‹è¯•å·¥ä½œæµç¡®ä¿æ­£å¸¸è¿è¡Œ

#### æ­¥éª¤ 2ï¼šå¯¼å‡º API æ ¼å¼

1. åœ¨ ComfyUI ç•Œé¢å³é”®ç‚¹å‡»ç©ºç™½å¤„
2. é€‰æ‹© "Export (API Format)"
3. å¤åˆ¶ç”Ÿæˆçš„ JSON ç»“æ„

#### æ­¥éª¤ 3ï¼šç†è§£èŠ‚ç‚¹ç»“æ„

å¯¼å‡ºçš„ JSON å…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹å¾ï¼š

```typescript
// æ¥è‡ªComfyUI "Export (API Format)"çš„åŸç”Ÿæ ¼å¼
const workflow = {
  '1': {
    _meta: { title: 'Load Checkpoint' },
    class_type: 'CheckpointLoaderSimple', // å¯¹åº”ComfyUIèŠ‚ç‚¹ç±»å‹
    inputs: {
      ckpt_name: modelFileName,
    },
  },
  '2': {
    _meta: { title: 'CLIP Text Encode' },
    class_type: 'CLIPTextEncode',
    inputs: {
      clip: ['1', 1], // [æºèŠ‚ç‚¹ID, è¾“å‡ºç«¯å£ç´¢å¼•]
      text: prompt,
    },
  },
  // ...æ›´å¤šèŠ‚ç‚¹
};
```

**å…³é”®è¦ç´ è¯´æ˜ï¼š**

- **èŠ‚ç‚¹ ID**: å¿…é¡»ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼ï¼ˆ'1', '2', '3'...ï¼‰
- **è¿æ¥æ ¼å¼**: `['1', 1]`è¡¨ç¤ºèŠ‚ç‚¹ 1 çš„è¾“å‡ºç«¯å£ 1
- **class\_type**: ç›´æ¥å¯¹åº” ComfyUI èŠ‚ç‚¹åº“ä¸­çš„å…·ä½“èŠ‚ç‚¹ç±»å‹
- **è¾“å‡ºç«¯å£**: 0 = ç¬¬ä¸€ä¸ªè¾“å‡ºï¼Œ1 = ç¬¬äºŒä¸ªè¾“å‡ºï¼Œä»¥æ­¤ç±»æ¨

### 2. å·¥ä½œæµæ¨¡æ¿ç»“æ„

åˆ›å»ºæ–°çš„å·¥ä½œæµæ–‡ä»¶ `workflows/your-workflow.ts`ï¼š

```typescript
import { PromptBuilder } from '@saintno/comfyui-sdk';

/**
 * æ„å»ºè‡ªå®šä¹‰å·¥ä½œæµï¼ˆåŸºäºComfyUIå¯¼å‡ºçš„JSONç»“æ„ï¼‰
 */
export function buildYourWorkflow(
  modelFileName: string,
  params: Record<string, any>,
): PromptBuilder<any, any, any> {
  const { prompt, width = 1024, height = 1024, steps = 20, cfg = 3.5, seed = -1 } = params;

  // æ­¤JSONç»“æ„æ¥è‡ªComfyUIçš„"Export (API Format)"
  const workflow = {
    '1': {
      _meta: { title: 'Load Checkpoint' },
      class_type: 'CheckpointLoaderSimple',
      inputs: {
        ckpt_name: modelFileName,
      },
    },
    '2': {
      _meta: { title: 'CLIP Text Encode' },
      class_type: 'CLIPTextEncode',
      inputs: {
        clip: ['1', 1], // è¿æ¥åˆ°èŠ‚ç‚¹1çš„CLIPè¾“å‡º
        text: prompt,
      },
    },
    '3': {
      _meta: { title: 'Empty Latent' },
      class_type: 'EmptyLatentImage',
      inputs: {
        width,
        height,
        batch_size: 1,
      },
    },
    '4': {
      _meta: { title: 'KSampler' },
      class_type: 'KSampler',
      inputs: {
        model: ['1', 0], // è¿æ¥åˆ°èŠ‚ç‚¹1çš„æ¨¡å‹è¾“å‡º
        positive: ['2', 0], // è¿æ¥åˆ°èŠ‚ç‚¹2çš„conditioningè¾“å‡º
        negative: ['2', 0], // å¯é…ç½®è´Ÿé¢æç¤ºè¯
        latent_image: ['3', 0],
        seed,
        steps,
        cfg,
        sampler_name: 'euler',
        scheduler: 'normal',
        denoise: 1.0,
      },
    },
    '5': {
      _meta: { title: 'VAE Decode' },
      class_type: 'VAEDecode',
      inputs: {
        samples: ['4', 0],
        vae: ['1', 2], // è¿æ¥åˆ°èŠ‚ç‚¹1çš„VAEè¾“å‡º
      },
    },
    '6': {
      _meta: { title: 'Save Image' },
      class_type: 'SaveImage',
      inputs: {
        filename_prefix: 'LobeChat_Custom',
        images: ['5', 0],
      },
    },
  };

  // åˆ›å»ºPromptBuilderåŒ…è£…åŸç”ŸComfyUI JSON
  const builder = new PromptBuilder(
    workflow,
    ['prompt', 'width', 'height', 'steps', 'seed', 'cfg'],
    ['images'],
  );

  // è®¾ç½®è¾“å‡ºèŠ‚ç‚¹
  builder.setOutputNode('images', '6');

  // è®¾ç½®è¾“å…¥èŠ‚ç‚¹æ˜ å°„
  builder.setInputNode('prompt', '2.inputs.text');
  builder.setInputNode('width', '3.inputs.width');
  builder.setInputNode('height', '3.inputs.height');
  builder.setInputNode('steps', '4.inputs.steps');
  builder.setInputNode('seed', '4.inputs.seed');
  builder.setInputNode('cfg', '4.inputs.cfg');

  return builder;
}
```

### 3. SD3.5 å·¥ä½œæµç¤ºä¾‹å‚è€ƒ

æŸ¥çœ‹`workflows/sd35-incl-clip.ts`ä½œä¸ºå®é™…å·¥ä½œæµçš„å‚è€ƒå®ç°ï¼š

```typescript
// å®Œæ•´çš„SD3.5å·¥ä½œæµå±•ç¤ºäº†æ ‡å‡†çš„7èŠ‚ç‚¹ç»“æ„
const workflow = {
  '1': { class_type: 'CheckpointLoaderSimple', inputs: { ckpt_name: modelFileName } },
  '2': { class_type: 'CLIPTextEncode', inputs: { clip: ['1', 1], text: prompt } },
  '3': { class_type: 'CLIPTextEncode', inputs: { clip: ['1', 1], text: negativePrompt } },
  '4': { class_type: 'EmptyLatentImage', inputs: { width, height, batch_size: 1 } },
  '5': { class_type: 'KSampler', inputs: {
    model: ['1', 0], positive: ['2', 0], negative: ['3', 0],
    latent_image: ['4', 0], seed, steps, cfg
  }},
  '6': { class_type: 'VAEDecode', inputs: { samples: ['5', 0], vae: ['1', 2] } },
  '7': { class_type: 'SaveImage', inputs: { images: ['6', 0] } },
};
```

### 4. æ›´æ–°å·¥ä½œæµè·¯ç”±

åœ¨ `utils/workflowRouter.ts` ä¸­æ·»åŠ è·¯ç”±é€»è¾‘ï¼š

```typescript
import { buildYourWorkflow } from '../workflows/your-workflow';

export class WorkflowRouter {
  static routeWorkflow(
    model: string,
    detectionResult: ModelDetectionResult,
    modelFileName: string,
    params: Record<string, any>
  ): PromptBuilder<any, any, any> {

    // ç°æœ‰è·¯ç”±é€»è¾‘...

    // æ·»åŠ æ–°å·¥ä½œæµè·¯ç”±
    if (detectionResult.variant === 'your_variant') {
      return buildYourWorkflow(model, modelFileName, params);
    }

    // é»˜è®¤å¤„ç†...
  }
}
```

### 3. æµ‹è¯•å·¥ä½œæµ

```typescript
// workflows/your-workflow.test.ts
import { buildYourWorkflow } from './your-workflow';

describe('Your Custom Workflow', () => {
  test('should build workflow with correct parameters', () => {
    const workflow = buildYourWorkflow('test-model', 'test.safetensors', {
      prompt: 'æµ‹è¯•æç¤ºè¯',
      width: 512,
      height: 512,
      steps: 10,
    });

    expect(workflow).toBeDefined();
    // éªŒè¯å·¥ä½œæµç»“æ„
    const nodes = workflow.getNodes();
    expect(nodes.length).toBeGreaterThan(0);
  });
});
```

## æ·»åŠ  LoRA æ”¯æŒ

### 1. æ›´æ–° LoRA æ³¨å†Œè¡¨

åœ¨ `config/loraRegistry.ts` ä¸­æ·»åŠ æ–°çš„ LoRAï¼š

```typescript
export const LORA_REGISTRY: Record<string, LoRAConfig> = {
  // ç°æœ‰LoRA...

  'your-custom-lora.safetensors': {
    compatibleVariants: ['dev', 'schnell'], // å…¼å®¹çš„æ¨¡å‹å˜ä½“
    modelFamily: 'FLUX',
    priority: 2, // 1=å®˜æ–¹, 2=ä¸“ä¸š, 3=ç¤¾åŒº
  },
};
```

### 2. åœ¨å·¥ä½œæµä¸­ä½¿ç”¨ LoRA

```typescript
// åœ¨å·¥ä½œæµæ„å»ºå™¨ä¸­æ·»åŠ LoRAèŠ‚ç‚¹
const loraLoader = new ComfyNodeBuilder('LoraLoader')
  .setInput('model', modelLoader.getOutput('model'))
  .setInput('clip', modelLoader.getOutput('clip'))
  .setInput('lora_name', 'your-custom-lora.safetensors')
  .setInput('strength_model', 1.0)
  .setInput('strength_clip', 1.0)
  .setTitle('LoRAåŠ è½½å™¨');

// æ›´æ–°åç»­èŠ‚ç‚¹ä½¿ç”¨LoRAå¢å¼ºçš„æ¨¡å‹
const textEncoder = new ComfyNodeBuilder('CLIPTextEncode')
  .setInput('text', prompt)
  .setInput('clip', loraLoader.getOutput('clip')) // ä½¿ç”¨LoRAå¢å¼ºçš„CLIP
  .setTitle('æ–‡æœ¬ç¼–ç å™¨');
```

## æ·»åŠ  ControlNet æ”¯æŒ

### 1. æ›´æ–° ControlNet æ³¨å†Œè¡¨

åœ¨ `config/controlnetRegistry.ts` ä¸­æ·»åŠ æ–°çš„ ControlNet æ¨¡å‹ï¼š

```typescript
export const CONTROLNET_REGISTRY: Record<string, ControlNetConfig> = {
  // ç°æœ‰æ¨¡å‹...

  'flux-controlnet-pose-v1.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
    type: 'pose', // æ–°çš„æ§åˆ¶ç±»å‹
  },
};
```

### 2. æ‰©å±• ControlNet æ¥å£

```typescript
export interface ControlNetConfig {
  compatibleVariants: string[];
  modelFamily: 'FLUX';
  priority: number;
  type: 'canny' | 'depth' | 'hed' | 'pose' | 'scribble' | 'normal' | 'semantic';
}
```

### 3. åœ¨å·¥ä½œæµä¸­ä½¿ç”¨ ControlNet

```typescript
// æ·»åŠ ControlNeté¢„å¤„ç†å™¨
const preprocessor = new ComfyNodeBuilder('CannyEdgePreprocessor')
  .setInput('image', inputImage)
  .setInput('low_threshold', 100)
  .setInput('high_threshold', 200)
  .setTitle('Cannyè¾¹ç¼˜é¢„å¤„ç†');

// æ·»åŠ ControlNetåº”ç”¨èŠ‚ç‚¹
const controlNetApply = new ComfyNodeBuilder('ControlNetApply')
  .setInput('conditioning', textEncoder.getOutput('conditioning'))
  .setInput('control_net', controlNetLoader.getOutput('control_net'))
  .setInput('image', preprocessor.getOutput('image'))
  .setInput('strength', 1.0)
  .setTitle('ControlNetåº”ç”¨');
```

## æ–°æ¶æ„ç‰¹æ€§è¯¦è§£

### 1. åˆ†å±‚é”™è¯¯å¤„ç†ç³»ç»Ÿ

LobeChat ComfyUI é›†æˆå¼•å…¥äº†åˆ†å±‚é”™è¯¯å¤„ç†æ¶æ„ï¼Œæä¾›ç²¾ç¡®çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†ï¼š

#### é”™è¯¯ç±»å‹å±‚æ¬¡ç»“æ„

```typescript
// åŸºç¡€é”™è¯¯ç±»å‹
ComfyUIInternalError
â”œâ”€â”€ ConfigError          // é…ç½®å±‚é”™è¯¯
â”œâ”€â”€ WorkflowError        // å·¥ä½œæµå±‚é”™è¯¯
â”œâ”€â”€ UtilsError          // å·¥å…·å±‚é”™è¯¯
â””â”€â”€ ModelResolverError  // æ¨¡å‹è§£æå™¨é”™è¯¯
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
import { ConfigError, WorkflowError, UtilsError } from '../errors';

// é…ç½®é”™è¯¯å¤„ç†
try {
  const config = getModelConfig(modelName);
} catch (error) {
  throw new ConfigError(
    `æ¨¡å‹é…ç½®ä¸å­˜åœ¨: ${modelName}`,
    ConfigError.Reasons.MISSING_CONFIG,
    { modelName }
  );
}

// å·¥ä½œæµé”™è¯¯å¤„ç†
try {
  const workflow = buildWorkflow(modelName, params);
} catch (error) {
  throw new WorkflowError(
    `å·¥ä½œæµæ„å»ºå¤±è´¥: ${error.message}`,
    WorkflowError.Reasons.INVALID_PARAMS,
    { modelName, params }
  );
}

// å·¥å…·é”™è¯¯å¤„ç†
try {
  const models = await resolver.getAvailableModels();
} catch (error) {
  throw new UtilsError(
    `æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥: ${error.message}`,
    UtilsError.Reasons.CONNECTION_ERROR,
    { server: baseURL }
  );
}
```

#### é”™è¯¯åŸå› å¸¸é‡

```typescript
// é…ç½®å±‚é”™è¯¯åŸå› 
ConfigError.Reasons = {
  CONFIG_PARSE_ERROR: 'CONFIG_PARSE_ERROR',    // é…ç½®è§£æé”™è¯¯
  INVALID_CONFIG: 'INVALID_CONFIG',            // æ— æ•ˆé…ç½®
  MISSING_CONFIG: 'MISSING_CONFIG',            // ç¼ºå¤±é…ç½®
  REGISTRY_ERROR: 'REGISTRY_ERROR',            // æ³¨å†Œè¡¨é”™è¯¯
};

// å·¥ä½œæµå±‚é”™è¯¯åŸå› 
WorkflowError.Reasons = {
  INVALID_CONFIG: 'INVALID_CONFIG',            // æ— æ•ˆé…ç½®
  INVALID_PARAMS: 'INVALID_PARAMS',            // æ— æ•ˆå‚æ•°
  MISSING_COMPONENT: 'MISSING_COMPONENT',      // ç¼ºå¤±ç»„ä»¶
  MISSING_ENCODER: 'MISSING_ENCODER',          // ç¼ºå¤±ç¼–ç å™¨
  UNSUPPORTED_MODEL: 'UNSUPPORTED_MODEL',      // ä¸æ”¯æŒçš„æ¨¡å‹
};

// å·¥å…·å±‚é”™è¯¯åŸå› 
UtilsError.Reasons = {
  CONNECTION_ERROR: 'CONNECTION_ERROR',        // è¿æ¥é”™è¯¯
  DETECTION_FAILED: 'DETECTION_FAILED',        // æ£€æµ‹å¤±è´¥
  INVALID_API_KEY: 'INVALID_API_KEY',          // æ— æ•ˆAPIå¯†é’¥
  INVALID_MODEL_FORMAT: 'INVALID_MODEL_FORMAT', // æ— æ•ˆæ¨¡å‹æ ¼å¼
  MODEL_NOT_FOUND: 'MODEL_NOT_FOUND',          // æ¨¡å‹æœªæ‰¾åˆ°
  NO_BUILDER_FOUND: 'NO_BUILDER_FOUND',        // æœªæ‰¾åˆ°æ„å»ºå™¨
  PERMISSION_DENIED: 'PERMISSION_DENIED',      // æƒé™è¢«æ‹’ç»
  ROUTING_FAILED: 'ROUTING_FAILED',            // è·¯ç”±å¤±è´¥
  SERVICE_UNAVAILABLE: 'SERVICE_UNAVAILABLE',  // æœåŠ¡ä¸å¯ç”¨
};
```

### 2. SD3.5 åŠ¨æ€ç¼–ç å™¨æ£€æµ‹ç³»ç»Ÿ

SD3.5 æ¨¡å‹æ”¯æŒå¤šç§ç¼–ç å™¨é…ç½®ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶é€‰æ‹©æœ€ä½³é…ç½®ï¼š

#### æ”¯æŒçš„ç¼–ç å™¨é…ç½®

1. **ä¸‰é‡ç¼–ç å™¨é…ç½®ï¼ˆæœ€ä½³è´¨é‡ï¼‰**: CLIP L + CLIP G + T5XXL
2. **åŒ CLIP é…ç½®**: CLIP L + CLIP Gï¼ˆæ—  T5ï¼‰
3. **T5 å•ç¼–ç å™¨é…ç½®**: ä»… T5XXL ç¼–ç å™¨

#### åŠ¨æ€æ£€æµ‹å®ç°

```typescript
// SD3.5 å·¥ä½œæµä¸­çš„åŠ¨æ€ç¼–ç å™¨æ£€æµ‹
function detectAvailableEncoder(): {
  type: 'triple' | 'dual_clip' | 't5';
  clipL?: string;
  clipG?: string;
  t5?: string;
} | null {
  // è·å–æ‰€æœ‰å¯ç”¨çš„CLIPå’ŒT5ç»„ä»¶
  const clipComponents = getAllComponentsWithNames({ type: 'clip' });
  const t5Components = getAllComponentsWithNames({ type: 't5' });

  // æŸ¥æ‰¾CLIP Lå’ŒCLIP G
  const clipL = clipComponents.find(c => c.name === 'clip_l.safetensors');
  const clipG = clipComponents.find(c => c.name === 'clip_g.safetensors');

  // æŸ¥æ‰¾T5XXLï¼ˆä¼˜å…ˆfp16ï¼Œå›é€€åˆ°fp8ï¼‰
  const t5 = t5Components.sort((a, b) => a.config.priority - b.config.priority)[0];

  // æœ€ä½³æƒ…å†µï¼šä¸‰ä¸ªç¼–ç å™¨éƒ½å¯ç”¨
  if (clipL && clipG && t5) {
    return { type: 'triple', clipL: clipL.name, clipG: clipG.name, t5: t5.name };
  }

  // åŒCLIPé…ç½®
  if (clipL && clipG) {
    return { type: 'dual_clip', clipL: clipL.name, clipG: clipG.name };
  }

  // ä»…T5é…ç½®
  if (t5) {
    return { type: 't5', t5: t5.name };
  }

  return null; // æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç¼–ç å™¨é…ç½®
}
```

#### SD3.5 å·¥ä½œæµæ„å»º

```typescript
export function buildSD35Workflow(
  modelFileName: string,
  params: Record<string, any>
): PromptBuilder<any, any, any> {
  // æ£€æµ‹å¯ç”¨ç¼–ç å™¨
  const encoderConfig = detectAvailableEncoder();

  // SD3.5 å¿…éœ€å¤–éƒ¨ç¼–ç å™¨
  if (!encoderConfig) {
    throw new WorkflowError(
      'SD3.5 æ¨¡å‹éœ€è¦å¤–éƒ¨CLIP/T5ç¼–ç å™¨æ–‡ä»¶',
      WorkflowError.Reasons.MISSING_ENCODER,
      { model: modelFileName }
    );
  }

  // åŸºäºæ£€æµ‹ç»“æœæ„å»ºä¸åŒçš„å·¥ä½œæµèŠ‚ç‚¹
  const workflow = buildWorkflowNodes(encoderConfig, params);

  return new PromptBuilder(workflow, inputs, outputs);
}
```

### 3. å››å¤§é…ç½®æ³¨å†Œè¡¨ç³»ç»Ÿ

æ–°æ¶æ„é‡‡ç”¨å››ä¸ªç‹¬ç«‹çš„é…ç½®æ³¨å†Œè¡¨ï¼Œå®ç°ç²¾ç¡®çš„èµ„æºç®¡ç†ï¼š

#### 3.1 æ¨¡å‹æ³¨å†Œè¡¨ï¼ˆmodelRegistry.tsï¼‰

ç®¡ç† 127 ä¸ª FLUX å’Œ SD3.5 æ¨¡å‹çš„é…ç½®ä¿¡æ¯ï¼š

```typescript
// æ¨¡å‹é…ç½®æ¥å£
export interface ModelConfig {
  modelFamily: 'FLUX' | 'SD1' | 'SDXL' | 'SD3';          // æ¨¡å‹å®¶æ—
  priority: number;                                       // ä¼˜å…ˆçº§ï¼š1=å®˜æ–¹, 2=ä¼ä¸š, 3=ç¤¾åŒº
  recommendedDtype: 'default' | 'fp8_e4m3fn' | 'fp8_e5m2'; // æ¨èæ•°æ®ç±»å‹
  variant: 'dev' | 'schnell' | 'kontext' | 'krea' | 'sd35'; // æ¨¡å‹å˜ä½“
}

// æ³¨å†Œè¡¨ç¤ºä¾‹
export const MODEL_REGISTRY: Record<string, ModelConfig> = {
  // === ä¼˜å…ˆçº§1ï¼šå®˜æ–¹æ¨¡å‹ ===
  'flux1-dev.safetensors': {
    priority: 1,
    variant: 'dev',
    modelFamily: 'FLUX',
    recommendedDtype: 'default',
  },

  // === ä¼˜å…ˆçº§2ï¼šä¼ä¸šä¼˜åŒ–æ¨¡å‹ ===
  'flux1-dev-fp8-e4m3fn.safetensors': {
    priority: 2,
    variant: 'dev',
    modelFamily: 'FLUX',
    recommendedDtype: 'fp8_e4m3fn',
  },

  // === ä¼˜å…ˆçº§3ï¼šç¤¾åŒºå¾®è°ƒæ¨¡å‹ ===
  'real_dream_flux_v1.safetensors': {
    priority: 3,
    variant: 'dev',
    modelFamily: 'FLUX',
    recommendedDtype: 'default',
  },
};

// é€šç”¨æŸ¥è¯¢æ¥å£
export function getModelConfig(
  modelName: string,
  options?: {
    caseInsensitive?: boolean;
    modelFamily?: ModelConfig['modelFamily'];
    priority?: number;
    variant?: ModelConfig['variant'];
  }
): ModelConfig | undefined;

// æ ¹æ®å˜ä½“è·å–æ¨¡å‹åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
export function getModelsByVariant(variant: ModelConfig['variant']): string[];
```

#### 3.2 ç³»ç»Ÿç»„ä»¶æ³¨å†Œè¡¨ï¼ˆsystemComponents.tsï¼‰

ç®¡ç† 6 ä¸ªæ ¸å¿ƒç³»ç»Ÿç»„ä»¶ï¼ˆVAEã€CLIPã€T5 ç¼–ç å™¨ï¼‰ï¼š

```typescript
// ç»„ä»¶é…ç½®æ¥å£
export interface ComponentConfig {
  modelFamily: 'FLUX' | 'SD3';                    // æ¨¡å‹å®¶æ—
  priority: number;                               // ä¼˜å…ˆçº§ï¼š1=å¿…éœ€, 2=æ ‡å‡†, 3=å¯é€‰
  type: 'vae' | 'clip' | 't5';                   // ç»„ä»¶ç±»å‹
}

// ç³»ç»Ÿç»„ä»¶æ³¨å†Œè¡¨
export const SYSTEM_COMPONENTS: Record<string, ComponentConfig> = {
  // === å¿…éœ€ç»„ä»¶ï¼ˆä¼˜å…ˆçº§1ï¼‰===
  'ae.safetensors': {
    modelFamily: 'FLUX',
    priority: 1,
    type: 'vae',
  },
  'clip_l.safetensors': {
    modelFamily: 'FLUX',
    priority: 1,
    type: 'clip',
  },
  'clip_g.safetensors': {
    modelFamily: 'SD3',
    priority: 1,
    type: 'clip',
  },
  't5xxl_fp16.safetensors': {
    modelFamily: 'FLUX',
    priority: 1,
    type: 't5',
  },

  // === å¯é€‰ç»„ä»¶ ===
  't5xxl_fp8_e4m3fn.safetensors': {
    modelFamily: 'FLUX',
    priority: 2,
    type: 't5',
  },
};

// è·å–æœ€ä¼˜ç»„ä»¶
export function getOptimalComponent(type: ComponentConfig['type']): string;

// è·å–ç»„ä»¶é…ç½®
export function getComponentConfig(componentName: string): ComponentConfig | undefined;
```

#### 3.3 LoRA æ³¨å†Œè¡¨ï¼ˆloraRegistry.tsï¼‰

ç®¡ç† 23 ä¸ª LoRA é€‚é…å™¨çš„å…¼å®¹æ€§ä¿¡æ¯ï¼š

```typescript
// LoRAé…ç½®æ¥å£
export interface LoRAConfig {
  compatibleVariants: string[];                   // å…¼å®¹çš„æ¨¡å‹å˜ä½“
  modelFamily: 'FLUX';                           // æ¨¡å‹å®¶æ—
  priority: number;                              // ä¼˜å…ˆçº§ï¼š1=å®˜æ–¹, 2=ä¸“ä¸š, 3=ç¤¾åŒº
}

// LoRAæ³¨å†Œè¡¨ç¤ºä¾‹
export const LORA_REGISTRY: Record<string, LoRAConfig> = {
  // === XLabs-AIå®˜æ–¹LoRA ===
  'realism_lora.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
  },
  'anime_lora.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
  },

  // === LiblibAIä¸“ä¸šLoRA ===
  'flux-kodak-grain-lora.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 2,
  },

  // === ç¤¾åŒºå®éªŒLoRA ===
  'watercolor_painting_schnell_lora.safetensors': {
    compatibleVariants: ['schnell'],
    modelFamily: 'FLUX',
    priority: 3,
  },
};

// è·å–LoRAé…ç½®
export function getLoRAConfig(
  loraName: string,
  options?: {
    compatibleVariant?: string;
    modelFamily?: LoRAConfig['modelFamily'];
    priority?: number;
  }
): LoRAConfig | undefined;
```

#### 3.4 ControlNet æ³¨å†Œè¡¨ï¼ˆcontrolnetRegistry.tsï¼‰

ç®¡ç† 3 ä¸ª XLabs-AI å®˜æ–¹ ControlNet æ¨¡å‹ï¼š

```typescript
// ControlNeté…ç½®æ¥å£
export interface ControlNetConfig {
  compatibleVariants: string[];                   // å…¼å®¹å˜ä½“
  modelFamily: 'FLUX';                           // æ¨¡å‹å®¶æ—
  priority: number;                              // ä¼˜å…ˆçº§ï¼š1=å®˜æ–¹, 2=ç¤¾åŒº, 3=å®éªŒ
  type: 'canny' | 'depth' | 'hed' | 'pose' | 'scribble' | 'normal' | 'semantic'; // ç±»å‹
}

// ControlNetæ³¨å†Œè¡¨
export const CONTROLNET_REGISTRY: Record<string, ControlNetConfig> = {
  'flux-controlnet-canny-v3.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
    type: 'canny',
  },
  'flux-controlnet-depth-v3.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
    type: 'depth',
  },
  'flux-controlnet-hed-v3.safetensors': {
    compatibleVariants: ['dev'],
    modelFamily: 'FLUX',
    priority: 1,
    type: 'hed',
  },
};

// è·å–ControlNeté…ç½®
export function getControlNetConfig(
  controlnetName: string,
  options?: {
    compatibleVariant?: string;
    type?: ControlNetConfig['type'];
  }
): ControlNetConfig | undefined;
```

### 4. ModelResolver O (1) æŸ¥æ‰¾ä¼˜åŒ–

æ–°çš„ ModelResolver å®ç° O (1) æ—¶é—´å¤æ‚åº¦çš„æ¨¡å‹æŸ¥æ‰¾ï¼Œå¤§å¹…æå‡æ€§èƒ½ï¼š

#### æ ¸å¿ƒä¼˜åŒ–ç‰¹æ€§

1. **ç›´æ¥å“ˆå¸Œè¡¨æŸ¥æ‰¾**: æ›¿ä»£çº¿æ€§æœç´¢ï¼Œå®ç° O (1) æŸ¥æ‰¾
2. **æ™ºèƒ½ç¼“å­˜æœºåˆ¶**: 1 åˆ†é’Ÿ TTL ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
3. **ä¼˜å…ˆçº§è‡ªåŠ¨æ’åº**: åŸºäºæ¨¡å‹æ³¨å†Œè¡¨çš„ä¼˜å…ˆçº§ç³»ç»Ÿ
4. **é”™è¯¯ç²¾ç¡®åˆ†ç±»**: HTTP çŠ¶æ€ç åˆ°å…·ä½“é”™è¯¯ç±»å‹çš„æ˜ å°„

#### æ¨¡å‹è§£æå®ç°

```typescript
/**
 * ç®€å•æ¨¡å‹è§£æå™¨ - é€šè¿‡ getModelConfig æ¥å£å®ç° O(1) æŸ¥æ‰¾
 */
export function resolveModel(modelName: string): ModelConfig | null {
  // ç§»é™¤è·¯å¾„ï¼Œåªä¿ç•™æ–‡ä»¶å
  const fileName = modelName.split('/').pop() || modelName;

  // ç›´æ¥ O(1) æŸ¥æ‰¾
  let config = getModelConfig(fileName);

  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å¤§å°å†™ä¸æ•æ„ŸæŸ¥æ‰¾
  if (!config) {
    config = getModelConfig(fileName, { caseInsensitive: true });
  }

  return config || null;
}

/**
 * ModelResolverç±» - æä¾›æœåŠ¡å™¨æ¨¡å‹éªŒè¯å’Œç¼“å­˜
 */
export class ModelResolver {
  private modelCache: string[] | null = null;
  private cacheExpiry: number = 0;
  private readonly CACHE_TTL = 60_000; // 1åˆ†é’Ÿç¼“å­˜

  /**
   * æ™ºèƒ½æ¨¡å‹æ–‡ä»¶åè§£æ - æ”¯æŒå˜ä½“åå’Œç›´æ¥æ–‡ä»¶å
   */
  async resolveModelFileName(modelId: string): Promise<string> {
    // è·å–æœåŠ¡å™¨æ¨¡å‹åˆ—è¡¨
    const serverModels = await this.getAvailableModelFiles();

    // æ¨¡å‹IDåˆ°å˜ä½“çš„æ˜ å°„
    const modelIdToVariant: Record<string, string> = {
      'flux-dev': 'dev',
      'flux-schnell': 'schnell',
      'flux-kontext-dev': 'kontext',
      'flux-krea-dev': 'krea',
      'stable-diffusion-3.5': 'sd35',
    };

    const variantName = modelIdToVariant[modelId] ||
      (['dev', 'schnell', 'kontext', 'krea', 'sd35'].includes(modelId) ? modelId : null);

    // ä¼˜å…ˆçº§1: å˜ä½“åç§°åŒ¹é…
    if (variantName) {
      const variantModels = getModelsByVariant(variantName as ModelConfig['variant']);

      for (const candidateModel of variantModels) {
        if (serverModels.includes(candidateModel)) {
          return candidateModel; // æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§åŒ¹é…
        }
      }
    }

    // ä¼˜å…ˆçº§2: ç›´æ¥æ–‡ä»¶ååŒ¹é…ï¼ˆå‘åå…¼å®¹ï¼‰
    if (serverModels.includes(modelId)) {
      return modelId;
    }

    // ä¼˜å…ˆçº§3: åŸºäºæ¨¡å‹é…ç½®çš„å˜ä½“æŸ¥æ‰¾
    const config = getModelConfig(modelId);
    if (config?.variant) {
      const matchingFiles = serverModels
        .filter(serverFile => {
          const serverConfig = getModelConfig(serverFile);
          return serverConfig?.variant === config.variant;
        })
        .sort((a, b) => {
          const configA = getModelConfig(a);
          const configB = getModelConfig(b);
          return (configA?.priority || 999) - (configB?.priority || 999);
        });

      if (matchingFiles.length > 0) {
        return matchingFiles[0]; // è¿”å›æœ€é«˜ä¼˜å…ˆçº§åŒ¹é…
      }
    }

    throw new ModelResolverError(
      `æ¨¡å‹æœªæ‰¾åˆ°: ${modelId}`,
      ModelResolverError.Reasons.MODEL_NOT_FOUND,
      { modelId }
    );
  }
}
```

### 5. å·¥ä½œæµè·¯ç”±ç³»ç»Ÿå‡çº§

æ–°çš„ WorkflowRouter æä¾›ç²¾ç¡®çš„æ¨¡å‹åˆ°å·¥ä½œæµçš„è·¯ç”±é€»è¾‘ï¼š

#### è·¯ç”±ç­–ç•¥

1. **ç²¾ç¡®æ¨¡å‹åç§°åŒ¹é…**: ç›´æ¥æ˜ å°„ç‰¹å®šæ¨¡å‹ ID åˆ°å·¥ä½œæµæ„å»ºå™¨
2. **å˜ä½“åŒ¹é…**: åŸºäºæ¨¡å‹å˜ä½“é€‰æ‹©ç›¸åº”å·¥ä½œæµ
3. **é”™è¯¯å¤„ç†**: ä¸æ”¯æŒçš„æ¨¡å‹ç±»å‹æŠ›å‡ºå…·ä½“é”™è¯¯

#### è·¯ç”±å™¨å®ç°

```typescript
export class WorkflowRouter {
  // ç²¾ç¡®æ¨¡å‹åç§°æ˜ å°„
  private static readonly EXACT_MODEL_BUILDERS: Record<string, WorkflowBuilderFunction> = {
    'flux-dev': buildFluxDevWorkflow,
    'flux-schnell': buildFluxSchnellWorkflow,
    'flux-kontext-dev': buildFluxKontextWorkflow,
    'flux-krea-dev': buildFluxKreaWorkflow,
    'sd35': buildSD35Workflow,
    'sd35-incl-clip': buildSD35NoClipWorkflow,
  };

  // FLUXå˜ä½“æ˜ å°„
  private static readonly VARIANT_BUILDERS: Record<string, WorkflowBuilderFunction> = {
    'dev': buildFluxDevWorkflow,
    'schnell': buildFluxSchnellWorkflow,
    'kontext': buildFluxKontextWorkflow,
    'krea': buildFluxKreaWorkflow,
    'sd35': buildSD35Workflow,
    'sd35-incl-clip': buildSD35NoClipWorkflow,
  };

  /**
   * è·¯ç”±å·¥ä½œæµæ„å»º
   */
  static routeWorkflow(
    modelId: string,
    detectionResult: WorkflowDetectionResult,
    modelFileName: string,
    params: Record<string, any> = {}
  ): PromptBuilder<any, any, any> {

    // 1. é¦–å…ˆå°è¯•ç²¾ç¡®æ¨¡å‹åç§°åŒ¹é…
    const exactBuilder = this.EXACT_MODEL_BUILDERS[modelId];
    if (exactBuilder) {
      return exactBuilder(modelFileName, params);
    }

    // 2. ç„¶åå°è¯•å˜ä½“åŒ¹é…
    if (detectionResult.variant && this.VARIANT_BUILDERS[detectionResult.variant]) {
      const variantBuilder = this.VARIANT_BUILDERS[detectionResult.variant];
      return variantBuilder(modelFileName, params);
    }

    // 3. éƒ½æ— æ³•åŒ¹é…åˆ™æŠ›å‡ºé”™è¯¯
    throw new WorkflowError(
      `æœªæ‰¾åˆ°æ¨¡å‹${modelId}çš„å·¥ä½œæµæ„å»ºå™¨`,
      WorkflowError.Reasons.UNSUPPORTED_MODEL,
      {
        architecture: detectionResult.architecture,
        modelId,
        variant: detectionResult.variant
      }
    );
  }

  // è·å–æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
  static getExactlySupportedModels(): string[] {
    return Object.keys(this.EXACT_MODEL_BUILDERS);
  }

  // è·å–æ”¯æŒçš„å˜ä½“åˆ—è¡¨
  static getSupportedFluxVariants(): string[] {
    return Object.keys(this.VARIANT_BUILDERS);
  }
}
```

## å¼€å‘æœ€ä½³å®è·µ

### 1. é…ç½®é©±åŠ¨åŸåˆ™

- æ‰€æœ‰æ¨¡å‹ä¿¡æ¯å­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­ï¼Œé¿å…ç¡¬ç¼–ç 
- ä½¿ç”¨ä¼˜å…ˆçº§ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹
- æ”¯æŒåŠ¨æ€å›é€€æœºåˆ¶

### 2. æ–°æ¶æ„é”™è¯¯å¤„ç†

```typescript
import { ConfigError, WorkflowError, UtilsError } from '../errors';

// åœ¨å·¥ä½œæµæ„å»ºå™¨ä¸­ä½¿ç”¨åˆ†å±‚é”™è¯¯å¤„ç†
try {
  const workflow = buildYourWorkflow(model, modelFileName, params);
  return workflow;
} catch (error) {
  if (error instanceof WorkflowError) {
    // é‡æ–°æŠ›å‡ºå·¥ä½œæµé”™è¯¯ - å°†åœ¨ä¸»å…¥å£æ•è·å¹¶è½¬æ¢ä¸ºæ¡†æ¶é”™è¯¯
    throw error;
  }

  // è½¬æ¢ä¸ºå·¥ä½œæµé”™è¯¯
  throw new WorkflowError(
    `å·¥ä½œæµæ„å»ºå¤±è´¥: ${error.message}`,
    WorkflowError.Reasons.INVALID_PARAMS,
    { model, params }
  );
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

```typescript
// ä½¿ç”¨ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤è®¡ç®—
private static workflowCache: Map<string, PromptBuilder<any, any, any>> = new Map();

static getCachedWorkflow(key: string): PromptBuilder<any, any, any> | undefined {
  return this.workflowCache.get(key);
}

static setCachedWorkflow(key: string, workflow: PromptBuilder<any, any, any>): void {
  this.workflowCache.set(key, workflow);
}
```

### 4. æµ‹è¯•è¦†ç›–

ç¡®ä¿ä¸ºæ¯ä¸ªæ–°åŠŸèƒ½æ·»åŠ å¯¹åº”æµ‹è¯•ï¼š

```typescript
// é›†æˆæµ‹è¯•ç¤ºä¾‹
describe('ComfyUI Integration', () => {
  test('should handle new model workflow end-to-end', async () => {
    const comfyUI = new LobeComfyUI({
      baseURL: 'http://localhost:8188',
      authType: 'none',
    });

    const result = await comfyUI.createImage({
      model: 'your-new-model',
      params: {
        prompt: 'æµ‹è¯•å›¾åƒç”Ÿæˆ',
        width: 512,
        height: 512,
      },
    });

    expect(result.imageUrl).toBeDefined();
    expect(result.width).toBe(512);
    expect(result.height).toBe(512);
  });
});
```

## éƒ¨ç½²å’Œå‘å¸ƒ

### 1. éªŒè¯æ¸…å•

åœ¨å‘å¸ƒæ–°åŠŸèƒ½å‰ï¼Œç¡®ä¿ï¼š

- [ ] æ‰€æœ‰æ–°æ¨¡å‹å·²æ·»åŠ åˆ°å¯¹åº”æ³¨å†Œè¡¨
- [ ] å·¥ä½œæµæµ‹è¯•é€šè¿‡
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

### 2. æ–‡æ¡£æ›´æ–°

æ›´æ–°ç›¸å…³æ–‡æ¡£æ–‡ä»¶ï¼š

- `docs/usage/providers/comfyui.zh-CN.mdx` - ç”¨æˆ·æ–‡æ¡£
- `docs/development/basic/comfyui-development.zh-CN.mdx` - å¼€å‘æ–‡æ¡£
- README å’Œ CHANGELOG

### 3. æ–°æ¶æ„ç¤ºä¾‹ä»£ç 

å±•ç¤ºæ–°æ¶æ„çš„å®Œæ•´ä½¿ç”¨æµç¨‹ï¼š

#### 3.1 åŸºç¡€å›¾åƒç”Ÿæˆ

```typescript
import { LobeComfyUI } from '@/libs/model-runtime/comfyui';

// åˆå§‹åŒ–ComfyUIå®¢æˆ·ç«¯
const comfyUI = new LobeComfyUI({
  baseURL: process.env.COMFYUI_BASE_URL,
  authType: 'bearer',
  apiKey: process.env.COMFYUI_API_KEY,
});

// ä½¿ç”¨FLUX Devæ¨¡å‹ç”Ÿæˆå›¾åƒ
const result = await comfyUI.createImage({
  model: 'flux-dev', // è‡ªåŠ¨è·¯ç”±åˆ°æœ€ä½³FLUX Devæ¨¡å‹
  params: {
    prompt: 'ç¾ä¸½çš„é£æ™¯ç”»ï¼Œé«˜è´¨é‡ï¼Œè¯¦ç»†',
    width: 1024,
    height: 1024,
    steps: 20,
    cfg: 3.5,
    seed: -1,
  },
});

console.log('ç”Ÿæˆçš„å›¾åƒURL:', result.imageUrl);
```

#### 3.2 SD3.5 åŠ¨æ€ç¼–ç å™¨ç¤ºä¾‹

```typescript
// SD3.5æ¨¡å‹ä¼šè‡ªåŠ¨æ£€æµ‹å¯ç”¨ç¼–ç å™¨é…ç½®
const sd35Result = await comfyUI.createImage({
  model: 'stable-diffusion-3.5', // è‡ªåŠ¨æ£€æµ‹ç¼–ç å™¨é…ç½®
  params: {
    prompt: 'æœªæ¥ä¸»ä¹‰åŸå¸‚æ™¯è§‚ï¼Œèµ›åšæœ‹å…‹é£æ ¼',
    negativePrompt: 'ä½è´¨é‡ï¼Œæ¨¡ç³Šï¼Œå˜å½¢',
    width: 1344,
    height: 768,
    steps: 28,
    cfg: 4.5,
  },
});

// ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ï¼š
// 1. Tripleç¼–ç å™¨ï¼ˆCLIP L + CLIP G + T5ï¼‰- æœ€ä½³è´¨é‡
// 2. Dual CLIPï¼ˆCLIP L + CLIP Gï¼‰- å¦‚æœç¼ºå°‘T5
// 3. T5å•ç¼–ç å™¨ - å¦‚æœåªæœ‰T5å¯ç”¨
```

#### 3.3 ä¼ä¸šä¼˜åŒ–æ¨¡å‹ç¤ºä¾‹

```typescript
// ä½¿ç”¨FP8ä¼˜åŒ–æ¨¡å‹ï¼ˆæ›´å¿«æ¨ç†ï¼‰
const optimizedResult = await comfyUI.createImage({
  model: 'flux-dev', // ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³å¯ç”¨å˜ä½“
  params: {
    prompt: 'ä¸“ä¸šå•†åŠ¡è‚–åƒï¼Œé«˜åˆ†è¾¨ç‡',
    width: 768,
    height: 1024,
    steps: 15, // FP8æ¨¡å‹å¯ä»¥ç”¨æ›´å°‘çš„æ­¥æ•°
    cfg: 3.0,
    // ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ flux1-dev-fp8-e4m3fn.safetensors
  },
});
```

#### 3.4 LoRA é€‚é…å™¨ä½¿ç”¨ç¤ºä¾‹

```typescript
import { getLoRAConfig, getAllLoRAConfigs } from '../config/loraRegistry';

// æŸ¥è¯¢å…¼å®¹çš„LoRA
const compatibleLoras = getAllLoRAConfigs({
  compatibleVariant: 'dev',
  priority: 1 // åªè·å–å®˜æ–¹LoRA
});

console.log('å¯ç”¨çš„å®˜æ–¹LoRA:', compatibleLoras.map(l => l.name));

// åœ¨å·¥ä½œæµä¸­ä½¿ç”¨LoRA
const loraResult = await comfyUI.createImage({
  model: 'flux-dev',
  params: {
    prompt: 'anime style character, detailed face',
    width: 768,
    height: 768,
    // LoRAé…ç½®
    lora: 'anime_lora.safetensors',
    loraStrength: 0.8,
  },
});
```

#### 3.5 é”™è¯¯å¤„ç†ç¤ºä¾‹

```typescript
import {
  ConfigError,
  WorkflowError,
  UtilsError,
  ModelResolverError
} from '../errors';

try {
  const result = await comfyUI.createImage({
    model: 'nonexistent-model',
    params: { prompt: 'æµ‹è¯•' },
  });
} catch (error) {
  // æ–°æ¶æ„æä¾›ç²¾ç¡®çš„é”™è¯¯åˆ†ç±»
  if (error instanceof ModelResolverError) {
    switch (error.reason) {
      case ModelResolverError.Reasons.MODEL_NOT_FOUND:
        console.log('æ¨¡å‹æœªæ‰¾åˆ°ï¼Œå»ºè®®çš„æ›¿ä»£æ¨¡å‹ï¼š', error.details?.suggestions);
        break;
      case ModelResolverError.Reasons.INVALID_API_KEY:
        console.log('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®');
        break;
      case ModelResolverError.Reasons.SERVICE_UNAVAILABLE:
        console.log('ComfyUIæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        break;
    }
  } else if (error instanceof WorkflowError) {
    if (error.reason === WorkflowError.Reasons.MISSING_ENCODER) {
      console.log('SD3.5æ¨¡å‹éœ€è¦å¤–éƒ¨ç¼–ç å™¨æ–‡ä»¶');
    }
  }
}
```

#### 3.6 æ¨¡å‹æŸ¥è¯¢å’ŒéªŒè¯ç¤ºä¾‹

```typescript
import {
  getModelConfig,
  getModelsByVariant,
  getAllModelNames
} from '../config/modelRegistry';
import { ModelResolver } from '../utils/modelResolver';

// O(1)æ¨¡å‹æŸ¥è¯¢
const fluxDevConfig = getModelConfig('flux1-dev.safetensors');
console.log('FLUX Devé…ç½®:', {
  priority: fluxDevConfig?.priority,
  variant: fluxDevConfig?.variant,
  recommendedDtype: fluxDevConfig?.recommendedDtype,
});

// è·å–æ‰€æœ‰Devå˜ä½“æ¨¡å‹ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
const devModels = getModelsByVariant('dev');
console.log('å¯ç”¨çš„Devæ¨¡å‹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:', devModels.slice(0, 5));

// æœåŠ¡å™¨æ¨¡å‹éªŒè¯
const resolver = new ModelResolver(comfyUI.client);
const validation = await resolver.validateModel('flux-dev');

if (validation.exists) {
  console.log('å®é™…ä½¿ç”¨çš„æ¨¡å‹æ–‡ä»¶:', validation.actualFileName);
} else {
  console.log('æ¨¡å‹åœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨');
}
```

#### 3.7 é«˜çº§é…ç½®ç¤ºä¾‹

```typescript
import { WorkflowRouter } from '../utils/workflowRouter';
import { getOptimalComponent } from '../config/systemComponents';

// æ£€æŸ¥è·¯ç”±æ”¯æŒ
const isSupported = WorkflowRouter.hasExactSupport('flux-dev');
const supportedVariants = WorkflowRouter.getSupportedFluxVariants();

console.log('ç²¾ç¡®æ”¯æŒFLUX-Dev:', isSupported);
console.log('æ”¯æŒçš„å˜ä½“:', supportedVariants);

// è·å–æœ€ä¼˜ç³»ç»Ÿç»„ä»¶
const bestVAE = getOptimalComponent('vae');
const bestT5 = getOptimalComponent('t5');

console.log('æœ€ä½³VAEç»„ä»¶:', bestVAE); // 'ae.safetensors'
console.log('æœ€ä½³T5ç¼–ç å™¨:', bestT5); // 't5xxl_fp16.safetensors'

// è·¯ç”±ç»Ÿè®¡ä¿¡æ¯
const stats = WorkflowRouter.getRoutingStats();
console.log('è·¯ç”±å™¨ç»Ÿè®¡:', {
  ç²¾ç¡®æ”¯æŒçš„æ¨¡å‹æ•°é‡: stats.exactModelsCount,
  æ”¯æŒçš„å˜ä½“æ•°é‡: stats.supportedVariantsCount,
  æ€»æ„å»ºå™¨æ•°é‡: stats.totalBuilders,
});
```

## è´¡çŒ®æŒ‡å—

1. **Fork é¡¹ç›®**ï¼šåœ¨ GitHub ä¸Š fork LobeChat ä»“åº“
2. **åˆ›å»ºåˆ†æ”¯**ï¼š`git checkout -b feature/your-feature-name`
3. **å¼€å‘åŠŸèƒ½**ï¼šæŒ‰ç…§æœ¬æŒ‡å—å®ç°æ–°åŠŸèƒ½
4. **æ·»åŠ æµ‹è¯•**ï¼šç¡®ä¿æµ‹è¯•è¦†ç›–ç‡
5. **æ›´æ–°æ–‡æ¡£**ï¼šåŒæ­¥æ›´æ–°ç›¸å…³æ–‡æ¡£
6. **æäº¤ PR**ï¼šåˆ›å»ºè¯¦ç»†çš„ Pull Request

é€šè¿‡éµå¾ªè¿™ä¸ªæŒ‡å—ï¼Œæ‚¨å¯ä»¥è½»æ¾æ‰©å±• LobeChat çš„ ComfyUI é›†æˆåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¤šçš„æ¨¡å‹é€‰æ‹©å’Œå·¥ä½œæµé€‰é¡¹ã€‚
